# CI/CD Pipeline for Project Chimera
#
# Runs on every push and pull request.
# Validates: linting, spec compliance, and tests.

name: Chimera CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip install ruff

      - name: Run linter
        run: .venv/bin/python -m ruff check .

  spec-check:
    name: Spec Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify spec files exist
        run: make spec-check

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv pip install pydantic httpx pytest pytest-asyncio ruff

      - name: Run tests (TDD - failures expected)
        run: |
          .venv/bin/python -m pytest tests/ -v --tb=short || true
        # Note: `|| true` because tests are EXPECTED to fail in TDD phase.
        # Remove `|| true` once implementations are complete.
